<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">üì¶ Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn blue" onclick="voltarDashboard()">Voltar</button>
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
  <button class="btn purple" onclick="importarExcel()">Importar Excel</button>
  <button class="btn red" onclick="abrirExcluirTudo()">Excluir Tudo</button>
  <button class="btn orange" onclick="undoDelete()">‚Ü© Undo Delete</button>


  <input type="file" id="excelFile"
    accept=".xlsx,.xls"
    style="display:none"
    onchange="lerExcel(event)">
</div>


<div id="progressBox" style="display:none; margin-top:10px;">
  <div style="background:#eee;height:20px;border-radius:10px;">
    <div id="progressBar"
      style="height:20px;background:#16a34a;width:0%;border-radius:10px;">
    </div>
  </div>
</div>

<div class="form-grid">

<input id="codigo" readonly placeholder="C√≥digo">
<input id="nome" placeholder="Nome">

<select id="fornecedor"></select>

<input id="sku" placeholder="SKU">
<input id="cor" placeholder="Cor">

<select id="tamanho">
<option value="">Tamanho</option>
<option>P</option><option>M</option>
<option>G</option><option>GG</option>
<option>√öNICO</option><option>VARIADOS</option>
</select>

<input id="skuCompleto" disabled placeholder="SKU COMPLETO">

<input id="estoque" type="number" placeholder="Estoque">
<input id="custo" placeholder="Pre√ßo Custo">
<input id="venda" placeholder="Pre√ßo Venda">

<input id="variacao" readonly placeholder="Varia√ß√£o">

<input id="barcode" placeholder="NCM">
<input id="ano" placeholder="Ano">

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search"
placeholder="Buscar..."
onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>C√≥digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>Sku</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Sku Completo</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>Varia√ß√£o</th>
<th>NCM</th>
<th>Ano</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">
<h3>Fornecedores</h3>
<div class="actions" style="margin-bottom:15px;">

  <input id="novoFornecedor"
         class="search"
         placeholder="Nome do fornecedor">

  <button class="btn green"
          onclick="adicionarFornecedor()">
    Salvar
  </button>

</div>

<table class="tabela">
<tbody id="listaFornecedores"></tbody>
</table>
<button class="btn blue"
          onclick="fecharModal()">
    Cancelar
  </button>
</div>
</div>


<div class="modal-bg" id="modalExcluir">
<div class="modal">

<h3>‚ö†Ô∏è Confirma√ß√£o ERP</h3>

<input id="userDelete" placeholder="Usu√°rio">
<input id="passDelete" type="password" placeholder="Senha">

<div style="display:flex;gap:10px;margin-top:15px;">
  <button class="btn red" onclick="confirmarExcluirTudo()">
    Excluir Tudo
  </button>

  <button class="btn blue" onclick="fecharExcluirTudo()">
    Cancelar
  </button>
</div>

</div>
</div>





<script>

const token = localStorage.getItem("token");
if(!token) location.href="login.html";

/* ================= MAIUSCULO ================= */
document.addEventListener("input",e=>{
 if(e.target.tagName==="INPUT" &&
 !["custo","venda","userDelete","passDelete"].includes(e.target.id)){
   e.target.value=e.target.value.toUpperCase();
 }
});

/* ================= SKU ================= */

function atualizarSKU(){
 skuCompleto.value=[sku.value,cor.value,tamanho.value]
 .filter(Boolean).join("-");
}
sku.oninput=cor.oninput=tamanho.onchange=atualizarSKU;

/* ================= MOEDA ================= */

function limparMoeda(v){
 return parseFloat(String(v).replace(/[^\d]/g,''))/100||0;
}

function formatarMoeda(v){
 return Number(v||0).toLocaleString("pt-BR",{
 style:"currency",currency:"BRL"});
}

function formatarMoedaInput(inp){
 let v=inp.value.replace(/\D/g,'');
 if(!v){inp.value="";return;}
 v=(v/100).toFixed(2);
 v=v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
 inp.value="R$ "+v;
}

custo.oninput=()=>{
 formatarMoedaInput(custo);
 calcularVariacaoForm();
};

venda.oninput=()=>{
 formatarMoedaInput(venda);
 calcularVariacaoForm();
};

function calcularVariacaoTabela(c,v){
 if(!c) return "0%";
 return (((v-c)/c)*100).toFixed(2)+"%";
}

function calcularVariacaoForm(){
 const c=limparMoeda(custo.value);
 const v=limparMoeda(venda.value);
 if(!c||!v){variacao.value="";return;}
 variacao.value=calcularVariacaoTabela(c,v);
}

/* ================= PRODUTOS ================= */

async function carregarProdutos(){

 const r=await fetch("/products",{headers:{Authorization:"Bearer "+token}});
 const dados=await r.json();

 lista.innerHTML="";

 dados.forEach(p=>{

 lista.innerHTML+=`
 <tr data-id="${p.id}">
 <td>${p.codigo}</td>
 <td contenteditable data-campo="nome">${p.nome||""}</td>
 <td contenteditable data-campo="fornecedor">${p.fornecedor||""}</td>
 <td contenteditable data-campo="sku">${p.sku||""}</td>
 <td contenteditable data-campo="cor">${p.cor||""}</td>
 <td contenteditable data-campo="tamanho">${p.tamanho||""}</td>
 <td class="skuFull">${[p.sku,p.cor,p.tamanho].filter(Boolean).join("-")}</td>
 <td contenteditable data-campo="estoque">${p.estoque}</td>
 <td contenteditable data-campo="preco_custo">${formatarMoeda(p.preco_custo)}</td>
 <td contenteditable data-campo="preco_venda">${formatarMoeda(p.preco_venda)}</td>
 <td class="variacao">${calcularVariacaoTabela(p.preco_custo,p.preco_venda)}</td>
 <td contenteditable data-campo="barcode">${p.barcode||""}</td>
 <td contenteditable data-campo="ano">${p.ano||""}</td>
 <td><button onclick="excluirProduto(${p.id})">üóë</button></td>
 </tr>`;
 });
}

/* INLINE AUTO SAVE */
let t;
document.addEventListener("input",e=>{
 if(!e.target.hasAttribute("contenteditable")) return;
 clearTimeout(t);
 t=setTimeout(()=>salvarInline(e.target),500);
});

async function salvarInline(el){

 const row=el.closest("tr");
 const id=row.dataset.id;
 const campo=el.dataset.campo;

 let valor=el.innerText.trim();

 if(["preco_custo","preco_venda"].includes(campo)){
   valor=limparMoeda(valor);
   el.innerText=formatarMoeda(valor);
 }

 await fetch(`/products/${id}/campo`,{
  method:"PUT",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify({campo,valor})
 });

 row.querySelector(".variacao").innerText=
 calcularVariacaoTabela(
   limparMoeda(row.children[8].innerText),
   limparMoeda(row.children[9].innerText)
 );

 el.style.background="#bbf7d0";
 setTimeout(()=>el.style.background="",500);
}

/* CREATE */
async function salvar(){

 const dados={
  codigo:codigo.value,
  nome:nome.value,
  fornecedor:fornecedor.value,
  sku:sku.value,
  cor:cor.value,
  tamanho:tamanho.value,
  estoque:estoque.value,
  preco_custo:limparMoeda(custo.value),
  preco_venda:limparMoeda(venda.value),
  variacao:variacao.value,
  barcode:barcode.value,
  ano:ano.value
 };

 await fetch("/products",{
 method:"POST",
 headers:{
  "Content-Type":"application/json",
  Authorization:"Bearer "+token
 },
 body:JSON.stringify(dados)
 });

 limparFormulario();
 carregarProdutos();
 gerarCodigoAutomatico();
}

/* DELETE */
async function excluirProduto(id){
 await fetch("/products/"+id,{
 method:"DELETE",
 headers:{Authorization:"Bearer "+token}
 });
 carregarProdutos();
}

/* ================= FORNECEDORES ================= */

function abrirModal(){ modalFornecedor.style.display="flex"; }
function fecharModal(){ modalFornecedor.style.display="none"; }

async function carregarFornecedores(){
 const r=await fetch("/suppliers",{headers:{Authorization:"Bearer "+token}});
 const dados=await r.json();

 fornecedor.innerHTML="<option></option>";
 listaFornecedores.innerHTML="";

 dados.forEach(f=>{
 fornecedor.innerHTML+=`<option>${f.nome}</option>`;
 listaFornecedores.innerHTML+=`<tr><td>${f.nome}</td></tr>`;
 });
}

async function adicionarFornecedor(){
 if(!novoFornecedor.value) return;
 await fetch("/suppliers",{
 method:"POST",
 headers:{
 "Content-Type":"application/json",
 Authorization:"Bearer "+token
 },
 body:JSON.stringify({nome:novoFornecedor.value})
 });
 novoFornecedor.value="";
 carregarFornecedores();
}

/* ================= EXCEL ================= */

function importarExcel(){ excelFile.click(); }

async function lerExcel(event){

  const file = event.target.files[0];
  if(!file) return;

  const formData = new FormData();
  formData.append("file", file);

  document.getElementById("progressBox").style.display="block";

  fetch("/products/import-excel",{
    method:"POST",
    headers:{ Authorization:"Bearer "+token },
    body: formData
  });

  const timer = setInterval(async()=>{

    const r = await fetch("/products/import-progress",{
      headers:{ Authorization:"Bearer "+token }
    });

    const p = await r.json();

    if(p.total===0) return;

    const percent = (p.atual/p.total)*100;

    document.getElementById("progressBar").style.width =
      percent+"%";

    if(p.status==="done"){
      clearInterval(timer);
      carregarProdutos();
      alert("Importa√ß√£o finalizada üöÄ");
    }

  },500);
}
async function undoDelete(){

  const res = await fetch("/products/undo-delete",{
    method:"POST",
    headers:{ Authorization:"Bearer "+token }
  });

  if(res.ok){
    carregarProdutos();
    alert("Produto restaurado ‚úî");
  }else{
    alert("Nada para restaurar");
  }
}


/* ================= UTIL ================= */

function limparFormulario(){
 nome.value=sku.value=cor.value=tamanho.value="";
 custo.value=venda.value=variacao.value="";
 barcode.value=ano.value="";
 skuCompleto.value="";
}

async function gerarCodigoAutomatico(){
 const r=await fetch("/products/next-code",{headers:{Authorization:"Bearer "+token}});
 codigo.value=(await r.json()).codigo;
}

function buscar(v){
 document.querySelectorAll("#lista tr").forEach(r=>{
   r.style.display=r.innerText.toUpperCase().includes(v.toUpperCase())?"":"none";
 });
}

function voltarDashboard(){
 location.href="dashboard.html";
}

function abrirExcluirTudo(){
 document.getElementById("modalExcluir").style.display="flex";
}

function fecharExcluirTudo(){
 document.getElementById("modalExcluir").style.display="none";
}

async function confirmarExcluirTudo(){

 const username = document.getElementById("userDelete").value;
 const password = document.getElementById("passDelete").value;

 if(!username || !password){
   alert("Preencha usu√°rio e senha");
   return;
 }

 const res = await fetch("/products/clear-all",{
   method:"POST",
   headers:{
     "Content-Type":"application/json",
     Authorization:"Bearer "+token
   },
   body:JSON.stringify({username,password})
 });

 const data = await res.json();

 if(data.success){
   alert("Tabela limpa com sucesso");
   fecharExcluirTudo();
   carregarProdutos();
 }else{
   alert("Login inv√°lido");
 }
}




/* INIT */
window.onload=()=>{
 carregarProdutos();
 carregarFornecedores();
 gerarCodigoAutomatico();
};


</script>

</body>
</html>
