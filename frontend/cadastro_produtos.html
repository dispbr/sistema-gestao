<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">

<style>

/* ===== TOPO VOLTAR ===== */
.topbar{
 width:100%;
 background:#08162a;
 padding:15px 25px;
 position:fixed;
 top:0;
 left:0;
 z-index:1000;
}
.btn-voltar{
 background:#0b1f3a;
 color:white;
 border:none;
 padding:8px 15px;
 border-radius:6px;
 cursor:pointer;
}
.bg{ padding-top:80px; }

.tabela td,.tabela th{
 text-align:center;
 padding:10px;
}
.modal-body{
 max-height:300px;
 overflow:auto;
}
</style>
</head>

<body>

<div class="topbar">
 <button class="btn-voltar" onclick="window.location='dashboard.html'">â¬… Voltar</button>
</div>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<div class="actions">
<button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
<button class="btn blue" onclick="alterar()">Alterar</button>
<button class="btn purple" onclick="salvarEdicao()">Salvar</button>
</div>

<div class="form-grid">

<input id="id" hidden>

<div>
<label>CÃ³digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<input id="tamanho">
</div>

<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>PreÃ§o Custo</label>
<input id="custo" type="number">
</div>

<div>
<label>PreÃ§o Venda</label>
<input id="venda" type="number">
</div>

<div>
<label>CÃ³digo Barras</label>
<div style="display:flex;">
<input id="barcode" style="flex:1;">
<button onclick="gerarCodigo()">Gerar</button>
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th style="display:none;">ID</th>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Estoque</th>
<th>Venda</th>
<th>Barras</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">
<h3>Fornecedores</h3>

<input id="novoFornecedor" placeholder="Novo fornecedor">
<button onclick="criarFornecedor()">Adicionar</button>

<div id="listaFornecedores"></div>

<button onclick="fecharModal()">Fechar</button>
</div>
</div>

<script>
const token=localStorage.getItem("token");

/* ===== GERAR CODIGO SEQUENCIAL ===== */
async function gerarCodigoProduto(){
 const res=await fetch("/products?q=",{
  headers:{Authorization:"Bearer "+token}
 });
 const data=await res.json();

 let maior=0;
 data.forEach(p=>{
  const num=parseInt(p.codigo);
  if(num>maior) maior=num;
 });

 const novo=(maior+1).toString().padStart(4,"0");
 codigo.value=novo;
}

/* SKU AUTOMÃTICO */
sku.oninput=()=> skuCompleto.value=sku.value+"-"+cor.value+"-"+tamanho.value;
cor.oninput=sku.oninput;
tamanho.oninput=sku.oninput;

/* GERAR BARRAS */
function gerarCodigo(){
 barcode.value=Math.floor(Math.random()*999999999999);
}

/* SALVAR */
async function salvar(){
 await fetch("/products",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify({
   codigo:codigo.value,
   nome:nome.value,
   fornecedor:fornecedor.value,
   estoque:estoque.value,
   preco_custo:custo.value,
   preco_venda:venda.value
  })
 });

 alert("Produto salvo com sucesso!");
 gerarCodigoProduto();
 buscar("");
}

/* BUSCAR */
async function buscar(q){
 const res=await fetch("/products?q="+q,{
  headers:{Authorization:"Bearer "+token}
 });
 const data=await res.json();

 lista.innerHTML="";

 data.forEach(p=>{
  lista.innerHTML+=`
  <tr onclick="selecionar(${p.id},'${p.codigo}','${p.nome}','${p.fornecedor}',${p.estoque},${p.preco_custo},${p.preco_venda})">
  <td style="display:none;">${p.id}</td>
  <td>${p.codigo}</td>
  <td>${p.nome}</td>
  <td>${p.fornecedor}</td>
  <td>${p.sku||""}</td>
  <td>${p.cor||""}</td>
  <td>${p.tamanho||""}</td>
  <td>${p.estoque}</td>
  <td>${p.preco_venda}</td>
  <td>${p.barcode||""}</td>
  <td><button onclick="excluir(${p.id})">ðŸ—‘</button></td>
  </tr>`;
 });
}

/* SELECIONAR */
function selecionar(idp,c,n,f,e,cus,ven){
 id.value=idp;
 codigo.value=c;
 nome.value=n;
 fornecedor.value=f;
 estoque.value=e;
 custo.value=cus;
 venda.value=ven;
}

/* ALTERAR */
async function salvarEdicao(){
 await fetch("/products/"+id.value,{
  method:"PUT",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify({
   codigo:codigo.value,
   nome:nome.value,
   fornecedor:fornecedor.value,
   estoque:estoque.value,
   preco_custo:custo.value,
   preco_venda:venda.value
  })
 });

 alert("Produto alterado com sucesso!");
 buscar("");
}

/* EXCLUIR */
async function excluir(id){
 await fetch("/products/"+id,{
  method:"DELETE",
  headers:{Authorization:"Bearer "+token}
 });
 buscar("");
}

/* FORNECEDORES */
function abrirModal(){
 modalFornecedor.style.display="flex";
 carregarFornecedores();
}
function fecharModal(){modalFornecedor.style.display="none";}

async function carregarFornecedores(){
 const res=await fetch("/suppliers",{headers:{Authorization:"Bearer "+token}});
 const data=await res.json();

 fornecedor.innerHTML="";
 listaFornecedores.innerHTML="";

 data.forEach(f=>{
  fornecedor.innerHTML+=`<option>${f.nome}</option>`;
  listaFornecedores.innerHTML+=`<div>${f.nome}</div>`;
 });
}

async function criarFornecedor(){
 await fetch("/suppliers",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify({nome:novoFornecedor.value})
 });

 novoFornecedor.value="";
 carregarFornecedores();
}

/* INICIALIZAÃ‡ÃƒO */
buscar("");
carregarFornecedores();
gerarCodigoProduto();
</script>

</body>
</html>
