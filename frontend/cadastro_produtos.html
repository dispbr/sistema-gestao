<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn blue" onclick="voltarDashboard()">Voltar</button>
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
  <button class="btn red" onclick="excluirTudo()">Excluir Tudo</button>
  <button class="btn purple" onclick="importarExcel()">Importar Excel</button>

  <input type="file" id="excelFile" accept=".xlsx,.xls"
         style="display:none"
         onchange="lerExcel(event)">
</div>

<div class="form-grid">

<div><label>CÃ³digo</label><input id="codigo" readonly></div>
<div><label>Nome</label><input id="nome"></div>
<div><label>Fornecedor</label><select id="fornecedor"></select></div>
<div><label>SKU</label><input id="sku"></div>
<div><label>Cor</label><input id="cor"></div>

<div>
<label>Tamanho</label>
<select id="tamanho">
<option value="">Selecione</option>
<option>P</option>
<option>M</option>
<option>G</option>
<option>GG</option>
<option>ÃšNICO</option>
<option>VARIADOS</option>
</select>
</div>

<div><label>SKU Completo</label><input id="skuCompleto" disabled></div>
<div><label>Estoque</label><input id="estoque" type="number"></div>
<div><label>PreÃ§o Custo</label><input id="custo"></div>
<div><label>PreÃ§o Venda</label><input id="venda"></div>
<div><label>VariaÃ§Ã£o %</label><input id="variacao" readonly></div>
<div><label>NCM</label><input id="barcode"></div>
<div><label>Ano</label><input id="ano"></div>
</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<div style="display:flex; gap:10px; margin-bottom:10px;">
<select id="colunaBusca" class="search" style="max-width:220px;">
<option value="todas">Todas as colunas</option>
<option value="codigo">CÃ³digo</option>
<option value="nome">Nome</option>
<option value="fornecedor">Fornecedor</option>
</select>
</div>

<table class="tabela">
<thead>
<tr>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>SKU Completo</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>VariaÃ§Ã£o</th>
<th>NCM</th>
<th>Ano</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<script>

const token = localStorage.getItem("token");
if(!token) location.href="login.html";

/* ================= SKU COMPLETO ================= */

function atualizarSKU(){
  skuCompleto.value =
  [sku.value,cor.value,tamanho.value]
  .filter(Boolean).join("-");
}

sku.oninput = atualizarSKU;
cor.oninput = atualizarSKU;
tamanho.onchange = atualizarSKU;

/* ================= CARREGAR PRODUTOS ================= */

async function carregarProdutos(){

  const res = await fetch("/products",{
    headers:{ Authorization:"Bearer "+token }
  });

  const produtos = await res.json();
  lista.innerHTML="";

  produtos.forEach(p=>{

    lista.innerHTML+=`
    <tr data-id="${p.id}">

    <td>${p.codigo}</td>
    <td contenteditable data-campo="nome">${p.nome||""}</td>
    <td contenteditable data-campo="fornecedor">${p.fornecedor||""}</td>
    <td contenteditable data-campo="sku">${p.sku||""}</td>
    <td contenteditable data-campo="cor">${p.cor||""}</td>
    <td contenteditable data-campo="tamanho">${p.tamanho||""}</td>

    <td class="skuFull">
    ${[p.sku,p.cor,p.tamanho].filter(Boolean).join("-")}
    </td>

    <td contenteditable data-campo="estoque">${p.estoque||0}</td>

    <td contenteditable data-campo="preco_custo">
    ${formatarMoeda(p.preco_custo)}
    </td>

    <td contenteditable data-campo="preco_venda">
    ${formatarMoeda(p.preco_venda)}
    </td>

    <td class="variacao">
    ${calcularVariacaoTabela(p.preco_custo,p.preco_venda)}
    </td>

    <td contenteditable data-campo="barcode">${p.barcode||""}</td>
    <td contenteditable data-campo="ano">${p.ano||""}</td>

    <td><button onclick="excluirProduto(${p.id})">ðŸ—‘</button></td>

    </tr>`;
  });
}

/* ================= AUTO SAVE INLINE ================= */

document.addEventListener("input", e=>{

 if(!e.target.hasAttribute("contenteditable")) return;

 clearTimeout(window.saveTimer);

 window.saveTimer = setTimeout(()=>{
   salvarInline(e.target);
 },500);

});

async function salvarInline(el){

 const row = el.closest("tr");
 const id = row.dataset.id;
 const campo = el.dataset.campo;
 let valor = el.innerText.trim();

 if(campo==="preco_custo" || campo==="preco_venda"){
   valor = limparMoeda(valor);
   el.innerText = formatarMoeda(valor);
 }

 if(campo==="estoque" || campo==="ano"){
   valor = parseInt(valor)||0;
 }

 await fetch(`/products/${id}/campo`,{
   method:"PUT",
   headers:{
     "Content-Type":"application/json",
     Authorization:"Bearer "+token
   },
   body:JSON.stringify({campo,valor})
 });

 el.style.background="#bbf7d0";
 setTimeout(()=> el.style.background="",500);

 recalcularLinha(row);
}

/* ================= VARIAÃ‡ÃƒO ================= */

function recalcularLinha(row){

 const custo = limparMoeda(
 row.querySelector('[data-campo="preco_custo"]').innerText);

 const venda = limparMoeda(
 row.querySelector('[data-campo="preco_venda"]').innerText);

 row.querySelector(".variacao").innerText =
 calcularVariacaoTabela(custo,venda);

 row.querySelector(".skuFull").innerText =
 [
 row.querySelector('[data-campo="sku"]').innerText,
 row.querySelector('[data-campo="cor"]').innerText,
 row.querySelector('[data-campo="tamanho"]').innerText
 ].filter(Boolean).join("-");
}

function calcularVariacaoTabela(c,v){
 if(!c || c===0) return "0%";
 return (((v-c)/c)*100).toFixed(2)+"%";
}

/* ================= MOEDA ================= */

function limparMoeda(v){
 return parseFloat(String(v).replace(/[^\d]/g,''))/100 || 0;
}

function formatarMoeda(v){
 return Number(v||0).toLocaleString("pt-BR",{
 style:"currency",
 currency:"BRL"
 });
}

custo.addEventListener("input", ()=>{
 formatarMoedaInput(custo);
 calcularVariacao();
});

venda.addEventListener("input", ()=>{
 formatarMoedaInput(venda);
 calcularVariacao();
});

function formatarMoedaInput(input){
 let valor=input.value.replace(/\D/g,'');
 if(!valor){ input.value=""; return; }
 valor=(valor/100).toFixed(2);
 valor=valor.replace(".",",");
 valor=valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
 input.value="R$ "+valor;
}

function calcularVariacao(){
 const c=limparMoeda(custo.value);
 const v=limparMoeda(venda.value);
 if(!c||!v){ variacao.value=""; return; }
 variacao.value=(((v-c)/c)*100).toFixed(2)+"%";
}

/* ================= CRUD ================= */

async function salvar(){

 const dados={
  codigo:codigo.value,
  nome:nome.value,
  fornecedor:fornecedor.value,
  sku:sku.value,
  cor:cor.value,
  tamanho:tamanho.value,
  estoque:estoque.value,
  preco_custo:limparMoeda(custo.value),
  preco_venda:limparMoeda(venda.value),
  variacao:variacao.value,
  barcode:barcode.value,
  ano:ano.value,

 };

 await fetch("/products",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify(dados)
 });

 limparFormulario();
 carregarProdutos();
 gerarCodigoAutomatico();
}

async function excluirProduto(id){
 await fetch("/products/"+id,{
 method:"DELETE",
 headers:{Authorization:"Bearer "+token}
 });
 carregarProdutos();
}

/* ================= BUSCA ================= */

function buscar(valor){

 const termo=valor.toUpperCase();
 const coluna=document.getElementById("colunaBusca").value;

 document.querySelectorAll("#lista tr").forEach(row=>{

 const codigo=row.children[0].innerText.toUpperCase();
 const nome=row.children[1].innerText.toUpperCase();
 const fornecedor=row.children[2].innerText.toUpperCase();

 let texto="";

 if(coluna==="codigo") texto=codigo;
 else if(coluna==="nome") texto=nome;
 else if(coluna==="fornecedor") texto=fornecedor;
 else texto=row.innerText.toUpperCase();

 row.style.display=
 texto.includes(termo)?"":"none";
 });
}

/* ================= IMPORTAR EXCEL ================= */

function importarExcel(){
 document.getElementById("excelFile").click();
}

async function lerExcel(event){

 const file=event.target.files[0];
 if(!file) return;

 const formData=new FormData();
 formData.append("file",file);

 const res=await fetch("/products/import-excel",{
 method:"POST",
 headers:{Authorization:"Bearer "+token},
 body:formData
 });

 if(res.ok){
 alert("Importado com sucesso!");
 carregarProdutos();
 }else{
 alert("Erro ao importar");
 }

 event.target.value="";
}

async function excluirTudo(){

  const senha = prompt("Digite a senha ADMIN para apagar tudo:");

  if(!senha) return;

  const res = await fetch("/products/delete-all",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify({ senha })
  });

  if(res.ok){
    alert("Tabela limpa com sucesso!");
    carregarProdutos();
  }else{
    alert("Senha incorreta");
  }
}

function abrirModal(){
  document.getElementById("modalFornecedor").style.display="flex";
}

function fecharModal(){
  document.getElementById("modalFornecedor").style.display="none";
}


/* ================= INIT ================= */

window.onload=()=>{
 carregarProdutos();
carregarFornecedores();
 gerarCodigoAutomatico();
};

</script>

</body>
</html>
