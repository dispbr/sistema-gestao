<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>
<body>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<!-- BOTÃ•ES SUPERIORES -->
<div class="actions">
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
  <button class="btn red" onclick="exportarExcel()">Exportar Excel</button>
</div>

<!-- FORMULÃRIO -->
<div class="form-grid">

  <div>
    <label>CÃ³digo</label>
    <input id="codigo">
  </div>

  <div>
    <label>Nome</label>
    <input id="nome">
  </div>

  <div>
    <label>Fornecedor</label>
    <select id="fornecedor"></select>
  </div>

  <div>
    <label>Estoque</label>
    <input id="estoque" type="number">
  </div>

  <div>
    <label>PreÃ§o Custo</label>
    <input id="custo" type="number">
  </div>

  <div>
    <label>PreÃ§o Venda</label>
    <input id="venda" type="number">
  </div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="ðŸ” Buscar produto..."
onkeyup="buscarProdutos(this.value)">

<!-- TABELA -->
<table class="tabela">
<thead>
<tr>
<th>ID</th>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>Estoque</th>
<th>Venda</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="listaProdutos"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDOR -->
<div class="modal-bg" id="modalFornecedor">
  <div class="modal">
    <div class="modal-header">
      <h3>Gerenciar Fornecedores</h3>
      <button onclick="fecharModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <input id="novoFornecedor" placeholder="Novo fornecedor">
      <button onclick="criarFornecedor()">Adicionar</button>

      <div id="listaFornecedores"></div>
    </div>

    <button class="btn-close" onclick="fecharModal()">Fechar</button>
  </div>
</div>

<script>
const API = "https://sistema-gestao-yz16.onrender.com";
const token = localStorage.getItem("token");

if(!token) window.location="login.html";

/* =======================
   PRODUTOS
======================= */

async function salvar(){
  await fetch(API+"/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({
      codigo:codigo.value,
      nome:nome.value,
      fornecedor:fornecedor.value,
      estoque:estoque.value,
      preco_custo:custo.value,
      preco_venda:venda.value
    })
  });
  buscarProdutos("");
}

async function buscarProdutos(q){
  const res = await fetch(API+"/products?q="+q,{
    headers:{Authorization:"Bearer "+token}
  });
  const dados = await res.json();

  listaProdutos.innerHTML="";

  dados.forEach(p=>{
    listaProdutos.innerHTML+=`
    <tr>
      <td>${p.id}</td>
      <td>${p.codigo}</td>
      <td>${p.nome}</td>
      <td>${p.fornecedor}</td>
      <td>${p.estoque}</td>
      <td>R$ ${p.preco_venda}</td>
      <td>
        <button onclick="excluir(${p.id})">ðŸ—‘</button>
      </td>
    </tr>`;
  });
}

async function excluir(id){
  if(!confirm("Excluir produto?")) return;

  await fetch(API+"/products/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });

  buscarProdutos("");
}

/* =======================
   FORNECEDORES
======================= */

function abrirModal(){
  document.getElementById("modalFornecedor").style.display="flex";
  carregarFornecedores();
}

function fecharModal(){
  document.getElementById("modalFornecedor").style.display="none";
}

async function carregarFornecedores(){
  const res = await fetch(API+"/suppliers",{
    headers:{Authorization:"Bearer "+token}
  });
  const dados = await res.json();

  fornecedor.innerHTML="";
  listaFornecedores.innerHTML="";

  dados.forEach(f=>{
    fornecedor.innerHTML+=`<option>${f.nome}</option>`;
    listaFornecedores.innerHTML+=`<div>${f.nome}</div>`;
  });
}

async function criarFornecedor(){
  await fetch(API+"/suppliers",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({nome:novoFornecedor.value})
  });

  novoFornecedor.value="";
  carregarFornecedores();
}

/* =======================
   EXCEL
======================= */

function exportarExcel(){
  let tabela=document.querySelector("table").outerHTML;
  let blob=new Blob([tabela],{type:"application/vnd.ms-excel"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="relatorio_produtos.xls";
  a.click();
}

buscarProdutos("");
carregarFornecedores();
</script>

</body>
</html>
