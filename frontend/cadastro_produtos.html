<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn blue" onclick="voltarDashboard()">Voltar</button>
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>


<div class="form-grid">

<div>
<label>CÃ³digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<select id="tamanho">
<option value="">Selecione</option>
<option>P</option>
<option>M</option>
<option>G</option>
<option>GG</option>
<option>ÃšNICO</option>
<option>VARIADOS</option>
</select>
</div>

<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>PreÃ§o Custo</label>
<input id="custo">
</div>

<div>
<label>PreÃ§o Venda</label>
<input id="venda">
</div>

<div>
<label>VariaÃ§Ã£o %</label>
<input id="variacao" readonly>
</div>

<div>
<label>NCM</label>
<div class="barcode">
<input id="barcode">
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>SKU Completo</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>VariaÃ§Ã£o</th>
<th>NCM</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<script>

const token = localStorage.getItem("token");
if(!token) window.location.href="login.html";

/* ================= MAIÃšSCULO ================= */

document.addEventListener("input", function(e){
  if(e.target.tagName === "INPUT" || e.target.tagName === "SELECT"){
    if(e.target.id !== "custo" && e.target.id !== "venda" && e.target.id !== "variacao"){
      e.target.value = e.target.value.toUpperCase();
    }
  }
});

/* ================= SKU COMPLETO ================= */

const skuInput = document.getElementById("sku");
const corInput = document.getElementById("cor");
const tamanhoInput = document.getElementById("tamanho");
const skuCompletoInput = document.getElementById("skuCompleto");

function atualizarSKU(){
  const skuVal = skuInput.value.trim();
  const corVal = corInput.value.trim();
  const tamanhoVal = tamanhoInput.value.trim();

  if(!skuVal && !corVal && !tamanhoVal){
    skuCompletoInput.value="";
    return;
  }

  skuCompletoInput.value = `${skuVal}-${corVal}-${tamanhoVal}`;
}

skuInput.addEventListener("keyup", atualizarSKU);
corInput.addEventListener("keyup", atualizarSKU);
tamanhoInput.addEventListener("change", atualizarSKU);

/* ================= CARREGAR PRODUTOS ================= */

async function carregarProdutos(){

  const res = await fetch("/products",{ headers:{ Authorization:"Bearer "+token }});
  const produtos = await res.json();

  lista.innerHTML="";

  produtos.forEach(p=>{

    lista.innerHTML += `
    <tr data-id="${p.id}">
      <td>${p.codigo}</td>
      <td contenteditable data-campo="nome">${p.nome||""}</td>
      <td contenteditable data-campo="fornecedor">${p.fornecedor||""}</td>
      <td contenteditable data-campo="sku">${p.sku||""}</td>
      <td contenteditable data-campo="cor">${p.cor||""}</td>
      <td contenteditable data-campo="tamanho">${p.tamanho||""}</td>
      <td>${p.sku_completo || (p.sku+"-"+p.cor+"-"+p.tamanho)}</td>
      <td contenteditable data-campo="estoque">${p.estoque||0}</td>
      <td contenteditable data-campo="preco_custo">${p.preco_custo||0}</td>
      <td contenteditable data-campo="preco_venda">${p.preco_venda||0}</td>
      <td>${p.variacao||""}</td>
      <td contenteditable data-campo="barcode">${p.barcode||""}</td>
      <td><button onclick="excluirProduto(${p.id})">ðŸ—‘</button></td>
    </tr>`;
  });
}

/* ================= SALVAR ================= */

async function salvar(){

  const dados = {
    codigo: codigo.value,
    nome: nome.value,
    fornecedor: fornecedor.value,
    sku: sku.value,
    cor: cor.value,
    tamanho: tamanho.value,
    sku_completo: skuCompleto.value,
    estoque: estoque.value,
    preco_custo: limparMoeda(custo.value),
    preco_venda: limparMoeda(venda.value),
    variacao: variacao.value,
    barcode: barcode.value
  };

  const res = await fetch("/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify(dados)
  });

  if(!res.ok){ alert("Erro ao salvar"); return; }

  limparFormulario();
  carregarProdutos();
  gerarCodigoAutomatico();
}

/* ================= INLINE UPDATE ================= */

document.addEventListener("blur", async function(e){

  if(!e.target.hasAttribute("contenteditable")) return;

  const campo = e.target.dataset.campo;
  const row = e.target.closest("tr");
  const id = row.dataset.id;
  let valor = e.target.innerText;

  await fetch("/products/"+id+"/campo",{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify({campo,valor})
  });

  e.target.style.background="#dcfce7";
  setTimeout(()=>e.target.style.background="",500);

}, true);

/* ================= DELETE ================= */

async function excluirProduto(id){
  if(!confirm("Deseja excluir?")) return;
  await fetch("/products/"+id,{method:"DELETE",headers:{Authorization:"Bearer "+token}});
  carregarProdutos();
}

/* ================= VARIAÃ‡ÃƒO ================= */

function limparMoeda(valor){
  return parseFloat(valor.replace(/[^\d]/g,''))/100 || 0;
}

function formatarMoedaInput(input){
  let valor=input.value.replace(/\D/g,'');
  if(!valor){ input.value=""; return; }
  valor=(valor/100).toFixed(2)+'';
  valor=valor.replace(".",",");
  valor=valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  input.value="R$ "+valor;
}

function calcularVariacao(){
  const custoNumero=limparMoeda(custo.value);
  const vendaNumero=limparMoeda(venda.value);
  if(!custoNumero||!vendaNumero){ variacao.value=""; return;}
  const resultado=((vendaNumero-custoNumero)/custoNumero)*100;
  variacao.value=resultado.toFixed(2)+"%";
}

custo.addEventListener("input",function(){
  formatarMoedaInput(this);
  calcularVariacao();
});

venda.addEventListener("input",function(){
  formatarMoedaInput(this);
  calcularVariacao();
});

/* ================= UTIL ================= */

function limparFormulario(){
  nome.value="";
  sku.value="";
  cor.value="";
  tamanho.value="";
  estoque.value="";
  custo.value="";
  venda.value="";
  variacao.value="";
  barcode.value="";
}

async function gerarCodigoAutomatico(){
  const res = await fetch("/products/next-code",{headers:{Authorization:"Bearer "+token}});
  const data = await res.json();
  codigo.value=data.codigo;
}

window.onload=function(){
  carregarProdutos();
  gerarCodigoAutomatico();
};

/* ================= MODAL ================= */

function abrirModal(){
  document.getElementById("modalFornecedor").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modalFornecedor").style.display = "none";
}

function voltarDashboard(){
  window.location.href = "dashboard.html";
}

</script>

</body>
</html>
