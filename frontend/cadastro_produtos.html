<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>
<body>

<main class="bg">
<section class="card">

<h2 class="title">游닍 Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
  <button class="btn blue" onclick="exportarExcel()">Exportar Excel</button>
</div>

<div class="form-grid">

  <div>
    <label>C칩digo do Produto</label>
    <input id="codigo">
  </div>

  <div>
    <label>Nome do Produto</label>
    <input id="nome">
  </div>

  <div>
    <label>Fornecedor</label>
    <select id="fornecedor"></select>
  </div>

  <div>
    <label>SKU</label>
    <input id="sku">
  </div>

  <div>
    <label>C칩digo de Barras</label>
    <input id="barcode">
  </div>

  <div>
    <label>Cor</label>
    <input id="cor">
  </div>

  <div>
    <label>Tamanho</label>
    <input id="tamanho">
  </div>

  <div>
    <label>SKU Completo (Autom치tico)</label>
    <input id="skuCompleto" disabled>
  </div>

  <div>
    <label>Estoque</label>
    <input id="estoque" type="number">
  </div>

  <div>
    <label>Pre칞o Custo</label>
    <input id="custo" type="number" oninput="calcularVariacao()">
  </div>

  <div>
    <label>Pre칞o Venda</label>
    <input id="venda" type="number" oninput="calcularVariacao()">
  </div>

  <div>
    <label>Varia칞칚o %</label>
    <input id="variacao" disabled>
  </div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="游댌 Buscar produto..."
onkeyup="buscarProdutos(this.value)">

<table class="tabela">
<thead>
<tr>
<th>ID</th>
<th>C칩digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>Estoque</th>
<th>Venda</th>
<th>%</th>
<th>A칞칚o</th>
</tr>
</thead>
<tbody id="listaProdutos"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDOR -->
<div class="modal-bg" id="modalFornecedor">
  <div class="modal">
    <div class="modal-header">
      <h3>Gerenciar Fornecedores</h3>
      <button onclick="fecharModal()">칑</button>
    </div>

    <div class="modal-body">
      <input id="novoFornecedor" placeholder="Novo fornecedor">
      <button onclick="criarFornecedor()">Adicionar</button>
      <div id="listaFornecedores"></div>
    </div>

    <button class="btn-close" onclick="fecharModal()">Fechar</button>
  </div>
</div>

<script>
const API = "";
const token = localStorage.getItem("token");
if(!token) window.location="login.html";

/* ========================
   SKU AUTOM츼TICO
======================== */
function gerarSKUCompleto(){
  skuCompleto.value = sku.value + "-" + cor.value + "-" + tamanho.value;
}

sku.oninput = gerarSKUCompleto;
cor.oninput = gerarSKUCompleto;
tamanho.oninput = gerarSKUCompleto;

/* ========================
   VARIA칂츾O %
======================== */
function calcularVariacao(){
  const custoVal = parseFloat(custo.value);
  const vendaVal = parseFloat(venda.value);

  if(!custoVal || !vendaVal){
    variacao.value = "";
    return;
  }

  const perc = ((vendaVal - custoVal) / custoVal) * 100;
  variacao.value = perc.toFixed(2) + "%";
}

/* ========================
   SALVAR
======================== */
async function salvar(){
  await fetch(API+"/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({
      codigo:codigo.value,
      nome:nome.value,
      fornecedor:fornecedor.value,
      estoque:estoque.value,
      preco_custo:custo.value,
      preco_venda:venda.value
    })
  });

  buscarProdutos("");
}

/* ========================
   BUSCAR
======================== */
async function buscarProdutos(q){
  const res = await fetch(API+"/products?q="+q,{
    headers:{Authorization:"Bearer "+token}
  });
  const dados = await res.json();

  listaProdutos.innerHTML="";

  dados.forEach(p=>{
    const perc = ((p.preco_venda - p.preco_custo)/p.preco_custo)*100;

    listaProdutos.innerHTML+=`
    <tr>
      <td>${p.id}</td>
      <td>${p.codigo}</td>
      <td>${p.nome}</td>
      <td>${p.fornecedor}</td>
      <td>${p.estoque}</td>
      <td>R$ ${p.preco_venda}</td>
      <td>${perc.toFixed(1)}%</td>
      <td>
        <button onclick="excluir(${p.id})">游딈</button>
      </td>
    </tr>`;
  });
}

/* ========================
   EXCLUIR
======================== */
async function excluir(id){
  if(!confirm("Excluir produto?")) return;

  await fetch(API+"/products/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });

  buscarProdutos("");
}

/* ========================
   FORNECEDORES
======================== */
function abrirModal(){
  document.getElementById("modalFornecedor").style.display="flex";
  carregarFornecedores();
}
function fecharModal(){
  document.getElementById("modalFornecedor").style.display="none";
}
async function carregarFornecedores(){
  const res = await fetch(API+"/suppliers",{
    headers:{Authorization:"Bearer "+token}
  });
  const dados = await res.json();

  fornecedor.innerHTML="";
  listaFornecedores.innerHTML="";

  dados.forEach(f=>{
    fornecedor.innerHTML+=`<option>${f.nome}</option>`;
    listaFornecedores.innerHTML+=`<div>${f.nome}</div>`;
  });
}
async function criarFornecedor(){
  await fetch(API+"/suppliers",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({nome:novoFornecedor.value})
  });

  novoFornecedor.value="";
  carregarFornecedores();
}

/* ========================
   EXCEL
======================== */
function exportarExcel(){
  let tabela=document.querySelector("table").outerHTML;
  let blob=new Blob([tabela],{type:"application/vnd.ms-excel"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="relatorio_produtos.xls";
  a.click();
}

buscarProdutos("");
carregarFornecedores();
</script>

</body>
</html>
