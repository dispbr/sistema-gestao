<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">üì¶ Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn blue" onclick="voltarDashboard()">Voltar</button>
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>

<div class="form-grid">

<div>
<label>C√≥digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<select id="tamanho">
<option value="">Selecione</option>
<option>P</option>
<option>M</option>
<option>G</option>
<option>GG</option>
<option>√öNICO</option>
<option>VARIADOS</option>
</select>
</div>

<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>Pre√ßo Custo</label>
<input id="custo">
</div>

<div>
<label>Pre√ßo Venda</label>
<input id="venda">
</div>

<div>
<label>Varia√ß√£o %</label>
<input id="variacao" readonly>
</div>

<div>
<label>NCM</label>
<input id="barcode">
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>C√≥digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>SKU Completo</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>Varia√ß√£o</th>
<th>NCM</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">

<h3>Gerenciar Fornecedores</h3>

<div style="display:flex; gap:10px; margin-bottom:20px;">
<input id="novoFornecedor" placeholder="Novo fornecedor">
<button class="btn green" onclick="adicionarFornecedor()">Salvar</button>
</div>

<table class="tabela">
<thead>
<tr>
<th>Fornecedor</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="listaFornecedores"></tbody>
</table>

<button class="btn-close" onclick="fecharModal()">Fechar</button>

</div>
</div>

<script>

const token = localStorage.getItem("token");
if(!token) location.href="login.html";

/* ================= MAI√öSCULO ================= */
document.addEventListener("input", e=>{

 if(e.target.hasAttribute("contenteditable")){
   e.target.innerText = e.target.innerText.toUpperCase();
 }

 if(e.target.tagName==="INPUT"){
   if(!["custo","venda"].includes(e.target.id)){
     e.target.value = e.target.value.toUpperCase();
   }
 }

});


/* ================= SKU COMPLETO ================= */
function atualizarSKU(){
 skuCompleto.value =
 `${sku.value}-${cor.value}-${tamanho.value}`;
}
sku.oninput=atualizarSKU;
cor.oninput=atualizarSKU;
tamanho.onchange=atualizarSKU;

/* ================= CARREGAR PRODUTOS ================= */

async function carregarProdutos(){

  const res = await fetch("/products",{
    headers:{
      Authorization:"Bearer "+token
    }
  });

  const produtos = await res.json();

  lista.innerHTML="";

  produtos.forEach(p=>{

    /* ===== SKU COMPLETO AUTOM√ÅTICO ===== */
    const skuCompleto =
      `${p.sku || ""}-${p.cor || ""}-${p.tamanho || ""}`;

    /* ===== VARIA√á√ÉO AUTOM√ÅTICA ===== */
    const variacao = calcularVariacaoTabela(
      p.preco_custo,
      p.preco_venda
    );

    lista.innerHTML += `
    <tr data-id="${p.id}">

      <td>${p.codigo}</td>

      <td contenteditable data-campo="nome">${p.nome||""}</td>

      <td contenteditable data-campo="fornecedor">${p.fornecedor||""}</td>

      <td contenteditable data-campo="sku">${p.sku||""}</td>

      <td contenteditable data-campo="cor">${p.cor||""}</td>

      <td contenteditable data-campo="tamanho">${p.tamanho||""}</td>

      <!-- SKU COMPLETO AGORA FUNCIONA -->
      <td class="skuFull">${skuCompleto}</td>

      <td contenteditable data-campo="estoque">${p.estoque||0}</td>

      <!-- M√ÅSCARA R$ -->
      <td contenteditable data-campo="preco_custo">
        ${formatarMoeda(p.preco_custo)}
      </td>

      <td contenteditable data-campo="preco_venda">
        ${formatarMoeda(p.preco_venda)}
      </td>

      <!-- VARIA√á√ÉO FUNCIONANDO -->
      <td class="variacao">${variacao}</td>

      <td contenteditable data-campo="barcode">${p.barcode||""}</td>

      <td>
        <button onclick="excluirProduto(${p.id})">üóë</button>
      </td>

    </tr>`;
  });

}


/* ================= AUTO SAVE INLINE ================= */

let timeoutSave;

document.addEventListener("input", e=>{

 if(!e.target.hasAttribute("contenteditable")) return;

 clearTimeout(timeoutSave);

 timeoutSave = setTimeout(()=>{

   salvarInline(e.target);

 }, 600); // salva 600ms ap√≥s parar de digitar

});

async function salvarInline(el){

 const row = el.closest("tr");
 const id = row.dataset.id;
 const campo = el.dataset.campo;

 let valor = el.innerText.trim();

 if(campo==="preco_custo" || campo==="preco_venda"){
   valor = limparMoeda(valor);
 }

 if(campo==="estoque"){
   valor = parseInt(valor)||0;
 }
recalcularLinha(row);

 await fetch(`/products/${id}/campo`,{
   method:"PUT",
   headers:{
     "Content-Type":"application/json",
     Authorization:"Bearer "+token
   },
   body:JSON.stringify({campo,valor})
 });

 /* ===== feedback verde ===== */
 el.style.background="#bbf7d0";

 setTimeout(()=>{
   el.style.background="";
 },500);

 /* ===== recalcular varia√ß√£o ===== */
 recalcularLinha(row);
}

/* ================= RECALCULAR VARIA√á√ÉO ================= */

function recalcularLinha(row){

 const custo = limparMoeda(
   row.querySelector('[data-campo="preco_custo"]').innerText
 );

 const venda = limparMoeda(
   row.querySelector('[data-campo="preco_venda"]').innerText
 );

 const variacaoCell = row.querySelector(".variacao");

 variacaoCell.innerText =
   calcularVariacaoTabela(custo,venda);
}

function calcularVariacaoTabela(c,v){
 if(!c || c===0) return "0%";
 return (((v-c)/c)*100).toFixed(2)+"%";
}

/* ================= MOEDA ================= */

function limparMoeda(v){
 if(typeof v==="number") return v;
 return parseFloat(String(v).replace(/[^\d]/g,''))/100 || 0;
}

function formatarMoeda(v){
 return Number(v||0).toLocaleString("pt-BR",{
  style:"currency",
  currency:"BRL"
 });
}

/* ================= SALVAR PRODUTO ================= */

async function salvar(){

 const dados={
  codigo:codigo.value,
  nome:nome.value,
  fornecedor:fornecedor.value,
  sku:sku.value,
  cor:cor.value,
  tamanho:tamanho.value,
  sku_completo:skuCompleto.value,
  estoque:estoque.value,
  preco_custo:limparMoeda(custo.value),
  preco_venda:limparMoeda(venda.value),
  variacao:variacao.value,
  barcode:barcode.value
 };

 await fetch("/products",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify(dados)
 });

 limparFormulario();
 carregarProdutos();
 gerarCodigoAutomatico();
}

/* ================= DELETE ================= */

async function excluirProduto(id){
 await fetch("/products/"+id,{
  method:"DELETE",
  headers:{Authorization:"Bearer "+token}
 });
 carregarProdutos();
}

/* ================= UTIL ================= */

function limparFormulario(){
 nome.value="";
 sku.value="";
 cor.value="";
 tamanho.value="";
 skuCompleto.value="";
 estoque.value="";
 custo.value="";
 venda.value="";
 variacao.value="";
 barcode.value="";
}

async function gerarCodigoAutomatico(){
 const res=await fetch("/products/next-code",{
  headers:{Authorization:"Bearer "+token}
 });
 const data=await res.json();
 codigo.value=data.codigo;
}
/* ================= FORNECEDORES ================= */

async function carregarFornecedores(){

  const res = await fetch("/suppliers",{
    headers:{
      Authorization:"Bearer " + token
    }
  });

  const fornecedores = await res.json();

  const select = document.getElementById("fornecedor");
  const lista = document.getElementById("listaFornecedores");

  select.innerHTML = "<option value=''>Selecione</option>";
  lista.innerHTML = "";

  fornecedores.forEach(f=>{

    /* COMBOBOX */
    select.innerHTML += `
      <option value="${f.nome}">
        ${f.nome}
      </option>`;

    /* TABELA MODAL */
    lista.innerHTML += `
      <tr>
        <td>${f.nome}</td>
        <td>
          <button onclick="excluirFornecedor(${f.id})">
            üóë
          </button>
        </td>
      </tr>`;
  });
}

/* ========= ADICIONAR FORNECEDOR ========= */

async function adicionarFornecedor(){

  const nome = document.getElementById("novoFornecedor").value.trim();

  if(!nome) return;

  await fetch("/suppliers",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token
    },
    body: JSON.stringify({ nome })
  });

  document.getElementById("novoFornecedor").value = "";

  carregarFornecedores();
}

/* ========= EXCLUIR FORNECEDOR ========= */

async function excluirFornecedor(id){

  await fetch("/suppliers/" + id,{
    method:"DELETE",
    headers:{
      Authorization:"Bearer " + token
    }
  });

  carregarFornecedores();
}

/* ========= MODAL ========= */

function abrirModal(){
  document.getElementById("modalFornecedor").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modalFornecedor").style.display = "none";
}



/* ================= INIT ================= */

window.onload=()=>{
 carregarProdutos();
 carregarFornecedores();
 gerarCodigoAutomatico();
};

</script>

</body>
</html>
