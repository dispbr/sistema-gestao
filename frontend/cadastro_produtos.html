<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">

<style>
.topbar{
 width:100%;
 background:#08162a;
 padding:15px 25px;
 position:fixed;
 top:0;
 left:0;
 z-index:1000;
}
.btn-voltar{
 background:#0b1f3a;
 color:white;
 border:none;
 padding:8px 15px;
 border-radius:6px;
 cursor:pointer;
}
.bg{ padding-top:80px; }

.tabela td,.tabela th{
 text-align:center;
 padding:10px;
}

.modal{
 background:white;
 padding:20px;
 border-radius:10px;
 width:500px;
}

input,select{
 text-transform:uppercase;
}
</style>
</head>

<body>

<div class="topbar">
 <button class="btn-voltar" onclick="window.location='dashboard.html'">‚¨Ö Voltar</button>
</div>

<main class="bg">
<section class="card">

<h2 class="title">üì¶ Cadastro de Produtos</h2>

<div class="actions">
<button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>

<div class="form-grid">

<input id="id" hidden>

<div><label>C√≥digo</label><input id="codigo" readonly></div>
<div><label>Nome</label><input id="nome"></div>
<div><label>Fornecedor</label><select id="fornecedor"></select></div>
<div><label>SKU</label><input id="sku"></div>
<div><label>Cor</label><input id="cor"></div>
<div><label>Tamanho</label><input id="tamanho"></div>
<div><label>SKU Completo</label><input id="skuCompleto" disabled></div>
<div><label>Estoque</label><input id="estoque" type="number"></div>
<div><label>Custo</label><input id="custo" type="number"></div>
<div><label>Venda</label><input id="venda" type="number"></div>
<div><label>Varia√ß√£o %</label><input id="variacao" disabled></div>

<div>
<label>C√≥digo Barras</label>
<div style="display:flex;">
<input id="barcode" style="flex:1;">
<button onclick="gerarCodigo()">Gerar</button>
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>C√≥digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>Varia√ß√£o</th>
<th>Barras</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
  <div class="modal-card">

    <h2 class="title">üè¢ Gerenciar Fornecedores</h2>

    <div class="form-grid" style="grid-template-columns: 1fr 150px;">
      <div>
        <label>Nome do Fornecedor</label>
        <input id="fornecedorNome" placeholder="Digite o nome">
      </div>
      <div style="display:flex; align-items:end;">
        <button class="btn green" onclick="salvarFornecedor()">Salvar</button>
      </div>
    </div>

    <div class="actions" style="margin-top:15px;">
      <button class="btn blue" onclick="editarFornecedor()">Alterar</button>
      <button class="btn red" onclick="excluirFornecedor()">Excluir</button>
      <button class="btn purple" onclick="fecharModal()">Fechar</button>
    </div>

    <table class="tabela" style="margin-top:20px;">
      <thead>
        <tr>
          <th>Fornecedor</th>
        </tr>
      </thead>
      <tbody id="listaFornecedores"></tbody>
    </table>

  </div>
</div>


<script>
const token=localStorage.getItem("token");

/* MAIUSCULO AUTOM√ÅTICO */
document.addEventListener("input",e=>{
 if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT"){
  e.target.value=e.target.value.toUpperCase();
 }
});

/* VARIA√á√ÉO AUTOM√ÅTICA */
custo.oninput=venda.oninput=()=>{
 if(!custo.value||!venda.value) return;
 variacao.value=((venda.value-custo.value)/custo.value*100).toFixed(1)+"%";
};

/* SKU AUTOM√ÅTICO */
sku.oninput=()=> skuCompleto.value=sku.value+"-"+cor.value+"-"+tamanho.value;
cor.oninput=sku.oninput;
tamanho.oninput=sku.oninput;

/* GERAR CODIGO */
function gerarCodigo(){
 barcode.value=Math.floor(Math.random()*999999999999);
}

/* CODIGO SEQUENCIAL */
async function gerarCodigoProduto(){
 const res=await fetch("/products",{headers:{Authorization:"Bearer "+token}});
 const data=await res.json();
 let max=0;
 data.forEach(p=>{if(parseInt(p.codigo)>max) max=parseInt(p.codigo);});
 codigo.value=(max+1).toString().padStart(4,"0");
}

/* SALVAR PRODUTO */
async function salvar(){
 await fetch("/products",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   Authorization:"Bearer "+token
  },
  body:JSON.stringify({
   codigo:codigo.value,
   nome:nome.value,
   fornecedor:fornecedor.value,
   estoque:estoque.value,
   preco_custo:custo.value,
   preco_venda:venda.value
  })
 });
 alert("Produto salvo!");
 gerarCodigoProduto();
 buscar("");
}

/* BUSCAR */
async function buscar(q=""){
 const res=await fetch("/products?q="+q,{headers:{Authorization:"Bearer "+token}});
 const data=await res.json();

 lista.innerHTML="";
 data.forEach(p=>{
 const perc=((p.preco_venda-p.preco_custo)/p.preco_custo*100).toFixed(1)+"%";

 lista.innerHTML+=`
 <tr>
 <td>${p.codigo}</td>
 <td>${p.nome}</td>
 <td>${p.fornecedor}</td>
 <td>${p.sku||""}</td>
 <td>${p.cor||""}</td>
 <td>${p.tamanho||""}</td>
 <td>${p.estoque}</td>
 <td>${p.preco_custo}</td>
 <td>${p.preco_venda}</td>
 <td>${perc}</td>
 <td>${p.barcode||""}</td>
 <td><button onclick="excluir(${p.id})">üóë</button></td>
 </tr>`;
 });
}

/* FORNECEDORES */
let fornecedorSelecionado=null;

async function carregarFornecedores(){
 const res=await fetch("/suppliers",{headers:{Authorization:"Bearer "+token}});
 const data=await res.json();

 fornecedor.innerHTML="";
 listaFornecedores.innerHTML="";

 data.forEach(f=>{
 fornecedor.innerHTML+=`<option>${f.nome}</option>`;
 listaFornecedores.innerHTML+=`
 <tr onclick="fornecedorSelecionado=${f.id};fornecedorNome.value='${f.nome}'">
 <td>${f.nome}</td></tr>`;
 });
}

async function salvarFornecedor(){
 await fetch("/suppliers",{
  method:"POST",
  headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token},
  body:JSON.stringify({nome:fornecedorNome.value})
 });
 carregarFornecedores();
}

async function editarFornecedor(){
 await fetch("/suppliers/"+fornecedorSelecionado,{
  method:"PUT",
  headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token},
  body:JSON.stringify({nome:fornecedorNome.value})
 });
 carregarFornecedores();
}

async function excluirFornecedor(){
 await fetch("/suppliers/"+fornecedorSelecionado,{
  method:"DELETE",
  headers:{Authorization:"Bearer "+token}
 });
 carregarFornecedores();
}

function abrirModal(){ modalFornecedor.style.display="flex"; carregarFornecedores(); }
function fecharModal(){ modalFornecedor.style.display="none"; }

/* INIT */
gerarCodigoProduto();
buscar();
carregarFornecedores();
</script>

</body>
</html>
