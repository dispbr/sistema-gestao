<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">游닍 Cadastro de Produtos</h2>

<div class="actions">
<button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>

<div class="form-grid">

<div>
<label>C칩digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<select id="tamanho">
  <option value="">Selecione</option>
  <option>P</option>
  <option>M</option>
  <option>G</option>
  <option>GG</option>
  <option>칔NICO</option>
  <option>VARIADOS</option>
</select>
</div>


<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>Pre칞o Custo</label>
<input id="custo">
</div>

<div>
<label>Pre칞o Venda</label>
<input id="venda">
</div>

<div>
<label>Varia칞칚o %</label>
<input id="variacao" readonly>
</div>

<div>
<label>C칩digo de Barras</label>
<div class="barcode">
<input id="barcode">
<button class="btn blue small" onclick="gerarCodigo()">Gerar</button>
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar...">

<table class="tabela">
<thead>
<tr>
<th>C칩digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>Varia칞칚o</th>
<th>Barras</th>
<th>A칞칚o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- POPUP FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">

<h3>Gerenciar Fornecedores</h3>

<div style="display:flex; gap:10px; margin-bottom:20px;">
<input id="novoFornecedor" placeholder="Novo fornecedor">
<button class="btn green" onclick="adicionarFornecedor()">Salvar</button>
</div>

<table class="tabela">
<thead>
<tr>
<th>Fornecedor</th>
<th>A칞칚o</th>
</tr>
</thead>
<tbody id="listaFornecedores"></tbody>
</table>

<button class="btn-close" onclick="fecharModal()">Fechar</button>

</div>
</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

/* ================= MAI칔SCULO ================= */
document.addEventListener("input", function(e){
  if(e.target.tagName === "INPUT" || e.target.tagName === "SELECT"){
    e.target.value = e.target.value.toUpperCase();
  }
});

/* ================= SKU AUTOM츼TICO ================= */
function atualizarSKU(){
  skuCompleto.value = sku.value + "-" + cor.value + "-" + tamanho.value;
}

sku.oninput = atualizarSKU;
cor.oninput = atualizarSKU;
tamanho.oninput = atualizarSKU;

/* ================= VARIA칂츾O ================= */

function limparMoeda(valor){
  return valor.replace(/[^\d]/g,'')/100;
}

function calcularVariacao(){
  let c = limparMoeda(custo.value);
  let v = limparMoeda(venda.value);

  if(!c || !v){
    variacao.value = "";
    return;
  }

  let resultado = ((v-c)/c)*100;
  variacao.value = resultado.toFixed(2)+"%";
}

custo.addEventListener("input", calcularVariacao);
venda.addEventListener("input", calcularVariacao);

/* ================= SALVAR NO BANCO ================= */

async function salvar(){

  const dados = {
    codigo: codigo.value,
    nome: nome.value,
    fornecedor: fornecedor.value,
    sku: sku.value,
    cor: cor.value,
    tamanho: tamanho.value,
    estoque: estoque.value,
    preco_custo: limparMoeda(custo.value),
    preco_venda: limparMoeda(venda.value),
    variacao: variacao.value,
    barcode: barcode.value
  };

  const res = await fetch("/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify(dados)
  });

  const produto = await res.json();

  adicionarLinha(produto);

}

/* ================= ADICIONAR LINHA ================= */

function adicionarLinha(p){

  lista.innerHTML += `
  <tr data-id="${p.id}">

    <td>${p.codigo}</td>
    <td contenteditable="true">${p.nome}</td>
    <td contenteditable="true">${p.fornecedor}</td>
    <td contenteditable="true">${p.sku}</td>
    <td contenteditable="true">${p.cor}</td>
    <td contenteditable="true">${p.tamanho}</td>
    <td contenteditable="true">${p.estoque}</td>
    <td contenteditable="true">${p.preco_custo}</td>
    <td contenteditable="true">${p.preco_venda}</td>
    <td>${p.variacao}</td>
    <td contenteditable="true">${p.barcode}</td>

    <td>
      <button class="btn red small" onclick="excluir(this)">Excluir</button>
    </td>

  </tr>`;
}

/* ================= INLINE UPDATE ================= */

document.addEventListener("blur", async function(e){

  if(!e.target.hasAttribute("contenteditable")) return;

  if(role !== "admin"){
    alert("Somente ADMIN pode editar.");
    return;
  }

  const row = e.target.closest("tr");
  const id = row.getAttribute("data-id");

  const dados = {
    nome: row.children[1].innerText,
    fornecedor: row.children[2].innerText,
    sku: row.children[3].innerText,
    cor: row.children[4].innerText,
    tamanho: row.children[5].innerText,
    estoque: row.children[6].innerText,
    preco_custo: limparMoeda(row.children[7].innerText),
    preco_venda: limparMoeda(row.children[8].innerText),
    variacao: calcularVariacaoTabela(
                row.children[7].innerText,
                row.children[8].innerText),
    barcode: row.children[10].innerText
  };

  await fetch("/products/"+id,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify(dados)
  });

  row.style.background="#dcfce7";

  setTimeout(()=> row.style.background="", 600);

}, true);

/* ================= VARIA칂츾O TABELA ================= */

function calcularVariacaoTabela(custo,venda){
  let c = limparMoeda(custo);
  let v = limparMoeda(venda);
  if(c===0) return "0%";
  return (((v-c)/c)*100).toFixed(2)+"%";
}

/* ================= MODAL ================= */

function abrirModal(){
  document.getElementById("modalFornecedor").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modalFornecedor").style.display = "none";
}

/* ================= FORNECEDORES ================= */

function adicionarFornecedor(){

  const nomeFornecedor = document.getElementById("novoFornecedor").value;

  if(!nomeFornecedor) return;

  document.getElementById("listaFornecedores").innerHTML += `
    <tr>
      <td>${nomeFornecedor}</td>
      <td>
        <button class="btn red small"
          onclick="this.closest('tr').remove()">游딈</button>
      </td>
    </tr>
  `;

  document.getElementById("fornecedor").innerHTML += `
    <option>${nomeFornecedor}</option>
  `;

  document.getElementById("novoFornecedor").value = "";
}
/* ================= GERAR C칍DIGO DE BARRAS ================= */

function gerarCodigo(){

  const barcodeInput = document.getElementById("barcode");

  // Gera n칰mero aleat칩rio de 13 d칤gitos (padr칚o EAN)
  let codigo = "";

  for(let i = 0; i < 13; i++){
    codigo += Math.floor(Math.random() * 10);
  }

  barcodeInput.value = codigo;
}

</script>

</body>
</html>
