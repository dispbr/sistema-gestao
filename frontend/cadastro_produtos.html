<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">üì¶ Cadastro de Produtos</h2>

<div class="actions">
<button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>

<div class="form-grid">

<div>
<label>C√≥digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<select id="tamanho">
  <option value="">Selecione</option>
  <option>P</option>
  <option>M</option>
  <option>G</option>
  <option>GG</option>
  <option>√öNICO</option>
  <option>VARIADOS</option>
</select>
</div>

<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>Pre√ßo Custo</label>
<input id="custo">
</div>

<div>
<label>Pre√ßo Venda</label>
<input id="venda">
</div>

<div>
<label>Varia√ß√£o %</label>
<input id="variacao" readonly>
</div>

<div>
<label>C√≥digo de Barras</label>
<div class="barcode">
<input id="barcode">
<button class="btn blue small" onclick="gerarCodigo()">Gerar</button>
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>C√≥digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>Varia√ß√£o</th>
<th>Barras</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">
<h3>Gerenciar Fornecedores</h3>

<div style="display:flex; gap:10px; margin-bottom:20px;">
<input id="novoFornecedor" placeholder="Novo fornecedor">
<button class="btn green" onclick="adicionarFornecedor()">Salvar</button>
</div>

<table class="tabela">
<thead>
<tr>
<th>Fornecedor</th>
<th>A√ß√£o</th>
</tr>
</thead>
<tbody id="listaFornecedores"></tbody>
</table>

<button class="btn-close" onclick="fecharModal()">Fechar</button>
</div>
</div>

<script>

const token = localStorage.getItem("token");
if(!token){
  window.location.href = "login.html";
}

/* ================= MAI√öSCULO AUTOM√ÅTICO ================= */

document.addEventListener("input", function(e){
  if(e.target.tagName === "INPUT"){
    if(e.target.id !== "custo" && e.target.id !== "venda"){
      e.target.value = e.target.value.toUpperCase();
    }
  }
});

/* ================= SKU COMPLETO AUTOM√ÅTICO ================= */

function atualizarSKU(){
  const skuVal = sku.value || "";
  const corVal = cor.value || "";
  const tamanhoVal = tamanho.value || "";

  skuCompleto.value = `${skuVal}-${corVal}-${tamanhoVal}`;
}

sku.addEventListener("input", atualizarSKU);
cor.addEventListener("input", atualizarSKU);
tamanho.addEventListener("change", atualizarSKU);

/* ================= CARREGAR PRODUTOS ================= */

async function carregarProdutos(){

  const res = await fetch("/products",{
    headers:{ Authorization:"Bearer " + token }
  });

  const produtos = await res.json();

  lista.innerHTML = "";

  produtos.forEach(p=>{
    lista.innerHTML += `
    <tr data-id="${p.id}">
      <td>${p.codigo}</td>
      <td contenteditable="true" data-campo="nome">${p.nome || ""}</td>
      <td contenteditable="true" data-campo="fornecedor">${p.fornecedor || ""}</td>
      <td contenteditable="true" data-campo="sku">${p.sku || ""}</td>
      <td contenteditable="true" data-campo="cor">${p.cor || ""}</td>
      <td contenteditable="true" data-campo="tamanho">${p.tamanho || ""}</td>
      <td contenteditable="true" data-campo="estoque">${p.estoque || 0}</td>
      <td contenteditable="true" data-campo="preco_custo">${p.preco_custo || 0}</td>
      <td contenteditable="true" data-campo="preco_venda">${p.preco_venda || 0}</td>
      <td>${p.variacao || ""}</td>
      <td contenteditable="true" data-campo="barcode">${p.barcode || ""}</td>
      <td><button onclick="excluirProduto(${p.id})">üóë</button></td>
    </tr>`;
  });
}

/* ================= SALVAR PRODUTO ================= */

async function salvar(){

  const dados = {
    codigo: codigo.value,
    nome: nome.value,
    fornecedor: fornecedor.value,
    sku: sku.value,
    cor: cor.value,
    tamanho: tamanho.value,
    estoque: estoque.value,
    preco_custo: limparMoeda(custo.value),
    preco_venda: limparMoeda(venda.value),
    variacao: variacao.value,
    barcode: barcode.value
  };

  const res = await fetch("/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token
    },
    body: JSON.stringify(dados)
  });

  if(!res.ok){
    alert("Erro ao salvar");
    return;
  }

  alert("Produto salvo com sucesso!");
  limparFormulario();
  carregarProdutos();
  gerarCodigoAutomatico();
}

/* ================= INLINE UPDATE ================= */

document.addEventListener("blur", async function(e){

  if(!e.target.hasAttribute("contenteditable")) return;

  const campo = e.target.dataset.campo;
  const row = e.target.closest("tr");
  const id = row.dataset.id;
  let valor = e.target.innerText;

  if(campo === "estoque"){
    valor = parseInt(valor) || 0;
  }

  if(campo === "preco_custo" || campo === "preco_venda"){
    valor = parseFloat(valor) || 0;
  }

  await fetch("/products/" + id + "/campo",{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token
    },
    body: JSON.stringify({ campo, valor })
  });

  e.target.style.background = "#dcfce7";
  setTimeout(()=> e.target.style.background="",500);

}, true);

/* ================= DELETE ================= */

async function excluirProduto(id){

  if(!confirm("Deseja excluir este produto?")) return;

  await fetch("/products/" + id,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token }
  });

  carregarProdutos();
}

/* ================= FORNECEDORES ================= */

async function carregarFornecedores(){

  const res = await fetch("/suppliers",{
    headers:{ Authorization:"Bearer " + token }
  });

  const fornecedores = await res.json();

  fornecedor.innerHTML = "<option value=''>Selecione</option>";
  listaFornecedores.innerHTML = "";

  fornecedores.forEach(f=>{
    fornecedor.innerHTML += `<option>${f.nome}</option>`;
    listaFornecedores.innerHTML += `
      <tr>
        <td>${f.nome}</td>
        <td><button onclick="excluirFornecedor(${f.id})">üóë</button></td>
      </tr>`;
  });
}

async function adicionarFornecedor(){

  if(!novoFornecedor.value) return;

  await fetch("/suppliers",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token
    },
    body: JSON.stringify({nome:novoFornecedor.value})
  });

  novoFornecedor.value="";
  carregarFornecedores();
}

async function excluirFornecedor(id){

  await fetch("/suppliers/" + id,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token }
  });

  carregarFornecedores();
}

/* ================= C√ìDIGO AUTOM√ÅTICO ================= */

async function gerarCodigoAutomatico(){

  const res = await fetch("/products/next-code",{
    headers:{ Authorization:"Bearer " + token }
  });

  const data = await res.json();
  codigo.value = data.codigo;
}

/* ================= M√ÅSCARA R$ ================= */

function limparMoeda(valor){
  return parseFloat(valor.replace(/[^\d]/g,'')) / 100 || 0;
}

function formatarMoedaInput(input){

  let valor = input.value.replace(/\D/g,'');

  if(!valor){
    input.value="";
    return;
  }

  valor = (valor/100).toFixed(2)+'';
  valor = valor.replace(".", ",");
  valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");

  input.value = "R$ " + valor;
}

function calcularVariacao(){

  const custoNumero = limparMoeda(custo.value);
  const vendaNumero = limparMoeda(venda.value);

  if(!custoNumero || !vendaNumero){
    variacao.value="";
    return;
  }

  const resultado = ((vendaNumero - custoNumero) / custoNumero) * 100;
  variacao.value = resultado.toFixed(2) + "%";
}

custo.addEventListener("input", function(){
  formatarMoedaInput(this);
  calcularVariacao();
});

venda.addEventListener("input", function(){
  formatarMoedaInput(this);
  calcularVariacao();
});

/* ================= LIMPAR ================= */

function limparFormulario(){
  nome.value="";
  sku.value="";
  cor.value="";
  tamanho.value="";
  estoque.value="";
  custo.value="";
  venda.value="";
  variacao.value="";
  barcode.value="";
}

/* ================= INIT ================= */

window.onload = function(){
  carregarProdutos();
  carregarFornecedores();
  gerarCodigoAutomatico();
};

</script>

</body>
</html>
