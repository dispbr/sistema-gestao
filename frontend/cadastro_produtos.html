<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<div class="actions">
  <button class="btn blue" onclick="voltarDashboard()">Voltar</button>
  <button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
  <button class="btn purple" onclick="importarExcel()">Importar Excel</button>
  <button class="btn red" onclick="abrirPopupDelete()">Excluir Tudo</button>

  <input type="file" id="excelFile"
    accept=".xlsx,.xls"
    style="display:none"
    onchange="lerExcel(event)">
</div>

<div id="progressBox" style="display:none;margin-top:10px;">
  <div style="background:#eee;height:20px;border-radius:10px;">
    <div id="progressBar"
      style="height:20px;background:#16a34a;width:0%;border-radius:10px;">
    </div>
  </div>
</div>

<div class="form-grid">

<input id="codigo" readonly placeholder="CÃ³digo">
<input id="nome" placeholder="Nome">
<select id="fornecedor"></select>

<input id="sku" placeholder="SKU">
<input id="cor" placeholder="Cor">

<select id="tamanho">
<option value="">Tamanho</option>
<option>P</option><option>M</option>
<option>G</option><option>GG</option>
<option>ÃšNICO</option><option>VARIADOS</option>
</select>

<input id="skuCompleto" disabled placeholder="SKU COMPLETO">

<input id="estoque" type="number" placeholder="Estoque">
<input id="custo" placeholder="PreÃ§o Custo">
<input id="venda" placeholder="PreÃ§o Venda">

<input id="variacao" readonly placeholder="VariaÃ§Ã£o">
<input id="barcode" placeholder="NCM">
<input id="ano" placeholder="Ano">

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>Sku</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Sku Completo</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>VariaÃ§Ã£o</th>
<th>NCM</th>
<th>Ano</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">
<h3>Fornecedores</h3>

<input id="novoFornecedor" class="search" placeholder="Nome fornecedor">

<button class="btn green" onclick="adicionarFornecedor()">Salvar</button>

<table class="tabela">
<tbody id="listaFornecedores"></tbody>
</table>

<button class="btn blue" onclick="fecharModal()">Fechar</button>
</div>
</div>

<!-- POPUP EXCLUIR -->
<div id="popupDelete" class="modal-bg" style="display:none;">
<div class="modal">
<h3>Excluir TODOS</h3>

<input id="userDelete" placeholder="UsuÃ¡rio">
<input id="passDelete" type="password" placeholder="Senha">

<button class="btn red" onclick="confirmarExcluirTudo()">Confirmar</button>
<button class="btn blue" onclick="fecharPopupDelete()">Cancelar</button>

</div>
</div>

<script>

const token = localStorage.getItem("token");
if(!token) location.href="login.html";

/* ================== UTIL ================== */

function limparMoeda(v){
 return parseFloat(String(v).replace(/[^\d]/g,''))/100||0;
}

function formatarMoeda(v){
 return Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function calcularVariacaoTabela(c,v){
 c=Number(c)||0;
 v=Number(v)||0;
 if(c<=0) return "0%";
 return (((v-c)/c)*100).toFixed(2)+"%";
}

/* ================= SKU ================= */

function atualizarSKU(){
 skuCompleto.value=[sku.value,cor.value,tamanho.value].filter(Boolean).join("-");
}
sku.oninput=cor.oninput=tamanho.onchange=atualizarSKU;

/* ================= PRODUTOS ================= */

async function carregarProdutos(){

 const r=await fetch("/products",{headers:{Authorization:"Bearer "+token}});
 const dados=await r.json();

 lista.innerHTML="";

 dados.forEach(p=>{
 lista.innerHTML+=`
 <tr data-id="${p.id}">
 <td>${p.codigo}</td>
 <td contenteditable data-campo="nome">${p.nome||""}</td>
 <td contenteditable data-campo="fornecedor">${p.fornecedor||""}</td>
 <td contenteditable data-campo="sku">${p.sku||""}</td>
 <td contenteditable data-campo="cor">${p.cor||""}</td>
 <td contenteditable data-campo="tamanho">${p.tamanho||""}</td>
 <td class="skuFull">${[p.sku,p.cor,p.tamanho].filter(Boolean).join("-")}</td>
 <td contenteditable data-campo="estoque">${p.estoque}</td>
 <td contenteditable data-campo="preco_custo">${formatarMoeda(p.preco_custo)}</td>
 <td contenteditable data-campo="preco_venda">${formatarMoeda(p.preco_venda)}</td>
 <td class="variacao">${calcularVariacaoTabela(p.preco_custo,p.preco_venda)}</td>
 <td contenteditable data-campo="barcode">${p.barcode||""}</td>
 <td contenteditable data-campo="ano">${p.ano||""}</td>
 <td><button onclick="excluirProduto(${p.id})">ðŸ—‘</button></td>
 </tr>`;
 });
}

/* ================= INLINE SAVE ================= */

let t;
document.addEventListener("input",e=>{
 if(!e.target.hasAttribute("contenteditable")) return;
 clearTimeout(t);
 t=setTimeout(()=>salvarInline(e.target),500);
});

async function salvarInline(el){

 const row=el.closest("tr");
 const id=row.dataset.id;
 const campo=el.dataset.campo;

 let valor=el.innerText.trim();

 if(["preco_custo","preco_venda"].includes(campo)){
   valor=limparMoeda(valor);
   el.innerText=formatarMoeda(valor);
 }

 await fetch(`/products/${id}/campo`,{
 method:"PUT",
 headers:{
 "Content-Type":"application/json",
 Authorization:"Bearer "+token
 },
 body:JSON.stringify({campo,valor})
 });

 row.querySelector(".variacao").innerText=
 calcularVariacaoTabela(
  limparMoeda(row.children[8].innerText),
  limparMoeda(row.children[9].innerText)
 );

 row.querySelector(".skuFull").innerText=
 [row.children[3].innerText,row.children[4].innerText,row.children[5].innerText]
 .filter(Boolean).join("-");

 el.style.background="#bbf7d0";
 setTimeout(()=>el.style.background="",500);
}

/* ================= CRUD ================= */

async function salvar(){
 await fetch("/products",{
 method:"POST",
 headers:{
 "Content-Type":"application/json",
 Authorization:"Bearer "+token
 },
 body:JSON.stringify({
 codigo:codigo.value,
 nome:nome.value,
 fornecedor:fornecedor.value,
 sku:sku.value,
 cor:cor.value,
 tamanho:tamanho.value,
 estoque:estoque.value,
 preco_custo:limparMoeda(custo.value),
 preco_venda:limparMoeda(venda.value),
 barcode:barcode.value,
 ano:ano.value
 })
 });

 carregarProdutos();
 gerarCodigoAutomatico();
}

/* ================= EXCLUIR TUDO ================= */

function abrirPopupDelete(){
 popupDelete.style.display="flex";
}

function fecharPopupDelete(){
 popupDelete.style.display="none";
}

/* ================= IMPORTAR ================= */

function importarExcel(){
 excelFile.click();
}

async function lerExcel(e){

 const file=e.target.files[0];
 if(!file) return;

 const formData=new FormData();
 formData.append("file",file);

 document.getElementById("progressBox").style.display="block";

 await fetch("/products/import-excel",{
 method:"POST",
 headers:{Authorization:"Bearer "+token},
 body:formData
 });

 carregarProdutos();
 alert("Importado âœ”");
}

/* ================= FORNECEDORES ================= */

function abrirModal(){ modalFornecedor.style.display="flex"; }
function fecharModal(){ modalFornecedor.style.display="none"; }

async function carregarFornecedores(){
 const r=await fetch("/suppliers",{headers:{Authorization:"Bearer "+token}});
 const dados=await r.json();

 fornecedor.innerHTML="<option></option>";
 listaFornecedores.innerHTML="";

 dados.forEach(f=>{
  fornecedor.innerHTML+=`<option>${f.nome}</option>`;
  listaFornecedores.innerHTML+=`<tr><td>${f.nome}</td></tr>`;
 });
}

/* ================= INIT ================= */

async function gerarCodigoAutomatico(){
 const r=await fetch("/products/next-code",{headers:{Authorization:"Bearer "+token}});
 codigo.value=(await r.json()).codigo;
}

window.onload=()=>{
 carregarProdutos();
 carregarFornecedores();
 gerarCodigoAutomatico();
};

function voltarDashboard(){
 location.href="dashboard.html";
}

</script>
</body>
</html>
