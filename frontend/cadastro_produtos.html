<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Cadastro de Produtos</title>
<link rel="stylesheet" href="cadastro_produtos.css">
</head>

<body>

<main class="bg">
<section class="card">

<h2 class="title">ðŸ“¦ Cadastro de Produtos</h2>

<div class="actions">
<button class="btn green" onclick="abrirModal()">Gerenciar Fornecedores</button>
</div>

<div class="form-grid">

<div>
<label>CÃ³digo</label>
<input id="codigo" readonly>
</div>

<div>
<label>Nome</label>
<input id="nome">
</div>

<div>
<label>Fornecedor</label>
<select id="fornecedor"></select>
</div>

<div>
<label>SKU</label>
<input id="sku">
</div>

<div>
<label>Cor</label>
<input id="cor">
</div>

<div>
<label>Tamanho</label>
<select id="tamanho">
  <option value="">Selecione</option>
  <option>P</option>
  <option>M</option>
  <option>G</option>
  <option>GG</option>
  <option>ÃšNICO</option>
  <option>VARIADOS</option>
</select>
</div>

<div>
<label>SKU Completo</label>
<input id="skuCompleto" disabled>
</div>

<div>
<label>Estoque</label>
<input id="estoque" type="number">
</div>

<div>
<label>PreÃ§o Custo</label>
<input id="custo">
</div>

<div>
<label>PreÃ§o Venda</label>
<input id="venda">
</div>

<div>
<label>VariaÃ§Ã£o %</label>
<input id="variacao" readonly>
</div>

<div>
<label>CÃ³digo de Barras</label>
<div class="barcode">
<input id="barcode">
<button class="btn blue small" onclick="gerarCodigo()">Gerar</button>
</div>
</div>

</div>

<button class="btn-submit" onclick="salvar()">Adicionar Produto</button>

<input class="search" placeholder="Buscar..." onkeyup="buscar(this.value)">

<table class="tabela">
<thead>
<tr>
<th>CÃ³digo</th>
<th>Nome</th>
<th>Fornecedor</th>
<th>SKU</th>
<th>Cor</th>
<th>Tamanho</th>
<th>Estoque</th>
<th>Custo</th>
<th>Venda</th>
<th>VariaÃ§Ã£o</th>
<th>Barras</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>
</main>

<!-- MODAL FORNECEDORES -->
<div class="modal-bg" id="modalFornecedor">
<div class="modal">
<h3>Gerenciar Fornecedores</h3>

<div style="display:flex; gap:10px; margin-bottom:20px;">
<input id="novoFornecedor" placeholder="Novo fornecedor">
<button class="btn green" onclick="adicionarFornecedor()">Salvar</button>
</div>

<table class="tabela">
<thead>
<tr>
<th>Fornecedor</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="listaFornecedores"></tbody>
</table>

<button class="btn-close" onclick="fecharModal()">Fechar</button>
</div>
</div>

<script>

const token = localStorage.getItem("token");
if(!token) window.location.href="login.html";

/* ================= GERAR CÃ“DIGO AUTOMÃTICO ================= */

async function gerarCodigoAutomatico(){
  const res = await fetch("/products/next-code",{
    headers:{ Authorization:"Bearer "+token }
  });
  const data = await res.json();
  codigo.value = data.codigo;
}

/* ================= CARREGAR PRODUTOS ================= */

async function carregarProdutos(q=""){
  const res = await fetch("/products?q="+q,{
    headers:{ Authorization:"Bearer "+token }
  });

  const produtos = await res.json();
  lista.innerHTML="";

  produtos.forEach(p=>{
    lista.innerHTML+=`
    <tr data-id="${p.id}">
      <td>${p.codigo}</td>
      <td contenteditable data-campo="nome">${p.nome}</td>
      <td contenteditable data-campo="fornecedor">${p.fornecedor}</td>
      <td contenteditable data-campo="sku">${p.sku}</td>
      <td contenteditable data-campo="cor">${p.cor}</td>
      <td contenteditable data-campo="tamanho">${p.tamanho}</td>
      <td contenteditable data-campo="estoque">${p.estoque}</td>
      <td contenteditable data-campo="preco_custo">${formatarMoeda(p.preco_custo)}</td>
      <td contenteditable data-campo="preco_venda">${formatarMoeda(p.preco_venda)}</td>
      <td>${p.variacao || ""}</td>
      <td contenteditable data-campo="barcode">${p.barcode}</td>
      <td><button onclick="excluirProduto(${p.id})">ðŸ—‘</button></td>
    </tr>`;
  });
}

function buscar(q){
  carregarProdutos(q);
}

/* ================= SALVAR ================= */

async function salvar(){

  const dados={
    codigo:codigo.value,
    nome:nome.value,
    fornecedor:fornecedor.value,
    sku:sku.value,
    cor:cor.value,
    tamanho:tamanho.value,
    estoque:estoque.value,
    preco_custo:limparMoeda(custo.value),
    preco_venda:limparMoeda(venda.value),
    variacao:variacao.value,
    barcode:barcode.value
  };

  const res=await fetch("/products",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify(dados)
  });

  if(!res.ok) return alert("Erro ao salvar");

  limparFormulario();
  gerarCodigoAutomatico();
  carregarProdutos();
}

/* ================= DELETE ================= */

async function excluirProduto(id){
  if(!confirm("Excluir produto?")) return;

  await fetch("/products/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });

  carregarProdutos();
}

/* ================= FORNECEDORES ================= */

function abrirModal(){
  modalFornecedor.style.display="flex";
  carregarFornecedores();
}

function fecharModal(){
  modalFornecedor.style.display="none";
}

async function carregarFornecedores(){
  const res=await fetch("/suppliers",{headers:{Authorization:"Bearer "+token}});
  const dados=await res.json();

  fornecedor.innerHTML="<option value=''>Selecione</option>";
  listaFornecedores.innerHTML="";

  dados.forEach(f=>{
    fornecedor.innerHTML+=`<option>${f.nome}</option>`;
    listaFornecedores.innerHTML+=`
    <tr>
      <td>${f.nome}</td>
      <td><button onclick="excluirFornecedor(${f.id})">ðŸ—‘</button></td>
    </tr>`;
  });
}

async function adicionarFornecedor(){
  if(!novoFornecedor.value) return;

  await fetch("/suppliers",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({nome:novoFornecedor.value})
  });

  novoFornecedor.value="";
  carregarFornecedores();
}

async function excluirFornecedor(id){
  await fetch("/suppliers/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });
  carregarFornecedores();
}

/* ================= MÃSCARA R$ ================= */

function formatarMoeda(valor){
  return Number(valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function limparMoeda(valor){
  return parseFloat(valor.replace(/[^\d]/g,''))/100||0;
}

custo.addEventListener("input",()=>{
  formatarInput(custo);
  calcularVariacao();
});

venda.addEventListener("input",()=>{
  formatarInput(venda);
  calcularVariacao();
});

function formatarInput(input){
  let valor=input.value.replace(/\D/g,'');
  if(!valor) return input.value="";
  valor=(valor/100).toFixed(2)+'';
  valor=valor.replace(".",",");
  valor=valor.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  input.value="R$ "+valor;
}

function calcularVariacao(){
  const c=limparMoeda(custo.value);
  const v=limparMoeda(venda.value);
  if(!c||!v) return variacao.value="";
  variacao.value=((v-c)/c*100).toFixed(2)+"%";
}

/* ================= INLINE SAVE ================= */

document.addEventListener("blur",async e=>{
  if(!e.target.hasAttribute("contenteditable")) return;

  const campo=e.target.dataset.campo;
  const row=e.target.closest("tr");
  const id=row.dataset.id;
  let valor=e.target.innerText;

  if(campo==="preco_custo"||campo==="preco_venda"){
    valor=limparMoeda(valor);
  }

  await fetch("/products/"+id+"/campo",{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({campo,valor})
  });

  if(campo==="preco_custo"||campo==="preco_venda"){
    const custo=limparMoeda(row.children[7].innerText);
    const venda=limparMoeda(row.children[8].innerText);
    if(custo){
      row.children[9].innerText=((venda-custo)/custo*100).toFixed(2)+"%";
    }
  }

  e.target.style.background="#dcfce7";
  setTimeout(()=>e.target.style.background="",500);

},true);

/* ================= OUTROS ================= */

function limparFormulario(){
  nome.value="";
  sku.value="";
  cor.value="";
  estoque.value="";
  custo.value="";
  venda.value="";
  variacao.value="";
  barcode.value="";
}

function gerarCodigo(){
  barcode.value=Math.floor(Math.random()*999999999999);
}

window.onload=()=>{
  carregarProdutos();
  carregarFornecedores();
  gerarCodigoAutomatico();
};

</script>
</body>
</html>
